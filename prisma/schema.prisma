// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model ParentUser {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String?

  weeklyEmailEnabled Boolean @default(true)

  childProfiles       ChildProfile[]
  sessions            Session[]
  accounts            Account[]
  passwordResetTokens PasswordResetToken[]

  // Saved items for activity logging
  facilities Facility[]
  coaches    Coach[]
  programs   Program[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parent_users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user ParentUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user ParentUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expires   DateTime
  used      Boolean  @default(false)

  user ParentUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

// ============================================
// CHILD PROFILE
// ============================================

model ChildProfile {
  id       String @id @default(cuid())
  parentId String

  nickname    String
  age         Int
  position    String?
  goals       Json // JSON array of selected goals
  avatarColor String @default("#3B82F6")

  freeTextEnabled     Boolean @default(false)
  trainingWindowStart String?
  trainingWindowEnd   String?

  parent            ParentUser              @relation(fields: [parentId], references: [id], onDelete: Cascade)
  sessionLogs       SessionLog[]
  challengeAttempts SkillChallengeAttempt[]
  lessonProgress    LessonProgress[]
  trainingPlans     TrainingPlan[]
  activities        Activity[]
  skillTrackLogs    SkillTrackDrillLog[]
  checkIns          CheckIn[]
  trainingArcs      TrainingArcState[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@map("child_profiles")
}

// ============================================
// TRAINING CONTENT
// ============================================

model Drill {
  id          String  @id @default(cuid())
  name        String
  category    String
  description String
  duration    Int?
  reps        Int?
  coachTip    String
  difficulty  String
  ageMin      Int     @default(8)
  ageMax      Int     @default(18)
  imageUrl    String?

  planDrills PlanDrill[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("drills")
}

model Lesson {
  id          String @id @default(cuid())
  title       String
  category    String
  content     String
  readingTime Int
  difficulty  String
  ageMin      Int    @default(8)
  ageMax      Int    @default(18)

  quizQuestions Json // JSON array of quiz questions

  progress LessonProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("lessons")
}

model SkillChallenge {
  id          String @id @default(cuid())
  name        String
  description String
  metric      String

  attempts SkillChallengeAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("skill_challenges")
}

// ============================================
// TRAINING PLANS
// ============================================

model TrainingPlan {
  id       String   @id @default(cuid())
  childId  String
  date     DateTime
  planType String

  child      ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  planDrills PlanDrill[]

  createdAt DateTime @default(now())

  @@unique([childId, date])
  @@map("training_plans")
}

model PlanDrill {
  id        String  @id @default(cuid())
  planId    String
  drillId   String
  order     Int
  completed Boolean @default(false)

  plan  TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  drill Drill        @relation(fields: [drillId], references: [id])

  @@unique([planId, drillId])
  @@map("plan_drills")
}

// ============================================
// SESSION LOGS
// ============================================

model SessionLog {
  id           String  @id @default(cuid())
  childId      String
  activityType String
  effortLevel  Int
  mood         String
  duration     Int?
  win          String?
  focus        String?

  child ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("session_logs")
}

// ============================================
// SKILL CHALLENGE ATTEMPTS
// ============================================

model SkillChallengeAttempt {
  id          String @id @default(cuid())
  childId     String
  challengeId String
  value       Int

  child     ChildProfile   @relation(fields: [childId], references: [id], onDelete: Cascade)
  challenge SkillChallenge @relation(fields: [challengeId], references: [id])

  createdAt DateTime @default(now())

  @@map("skill_challenge_attempts")
}

// ============================================
// LESSON PROGRESS
// ============================================

model LessonProgress {
  id        String  @id @default(cuid())
  childId   String
  lessonId  String
  completed Boolean @default(false)
  quizScore Int?
  quizTotal Int?

  child  ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  lesson Lesson       @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([childId, lessonId])
  @@map("lesson_progress")
}

// ============================================
// ACTIVITY LOGGING (Sessions, Games, Classes)
// ============================================

enum ActivityType {
  SELF_TRAINING
  COACH_1ON1
  TEAM_TRAINING
  FACILITY_CLASS
  OFFICIAL_GAME
  FUTSAL_GAME
  INDOOR_LEAGUE_GAME
}

enum GameIQImpact {
  LOW
  MEDIUM
  HIGH
}

// MVP: All facilities are manual. Future: add GOOGLE_MAPS when Places API is enabled.
// enum FacilitySource { GOOGLE_MAPS, MANUAL }

enum ProgramType {
  TEAM
  FUTSAL
  INDOOR
  CLASS
  OTHER
}

model Activity {
  id              String       @id @default(cuid())
  childId         String
  activityType    ActivityType
  startAt         DateTime     @default(now())
  durationMinutes Int
  locationName    String?
  opponentName    String?
  intensityRPE    Int?         // 1-10
  gameIQImpact    GameIQImpact @default(MEDIUM)
  notes           String?      // Parent-gated free text

  // Stable references (when using saved items)
  facilityId String?
  coachId    String?
  programId  String?

  // Freeform fallbacks (when typing manually without saving)
  facilityNameFreeform    String?
  facilityMapsUrlFreeform String?  // User-provided Maps URL for one-off entries
  coachNameFreeform       String?
  programNameFreeform     String?

  child    ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  facility Facility?    @relation(fields: [facilityId], references: [id])
  coach    Coach?       @relation(fields: [coachId], references: [id])
  program  Program?     @relation(fields: [programId], references: [id])

  focusTags  ActivityFocusTag[]
  highlights ActivityHighlightLog[]
  nextFocus  ActivityNextFocusLog[]
  checkIn    CheckIn?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("activities")
}

// ============================================
// SESSION CHECK-IN (Adaptive Session Mode)
// ============================================

enum Soreness {
  NONE
  LIGHT
  MEDIUM
  HIGH
}

enum SessionMode {
  PEAK
  NORMAL
  LOW_BATTERY
  RECOVERY
}

enum MoodEmoji {
  EXCITED    // ðŸ˜„
  FOCUSED    // ðŸŽ¯
  OKAY       // ðŸ˜Š
  TIRED      // ðŸ˜´
  STRESSED   // ðŸ˜°
}

model CheckIn {
  id        String      @id @default(cuid())
  childId   String
  energy    Int         // 1-5
  soreness  Soreness    @default(NONE)
  focus     Int         // 1-5
  mood      MoodEmoji   @default(OKAY)
  timeAvail Int         // 10, 20, 30 minutes
  painFlag  Boolean     @default(false)

  // Calculated mode
  mode           SessionMode @default(NORMAL)
  modeExplanation String?    // One-line reason for mode selection

  // Post-session rating (tap-first 1-5)
  qualityRating Int?
  completed     Boolean     @default(false)

  // Link to activity (optional, set when session is logged)
  activityId String? @unique

  child    ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)
  activity Activity?    @relation(fields: [activityId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("check_ins")
}

// ============================================
// TRAINING ARCS (Anime-style themed training)
// ============================================

enum ArcStatus {
  INACTIVE
  ACTIVE
  PAUSED
  COMPLETED
}

model TrainingArcState {
  id       String    @id @default(cuid())
  childId  String
  arcId    String    // vision | tempo | decision_chain
  status   ArcStatus @default(INACTIVE)
  startDate DateTime?
  dayIndex Int       @default(0) // Current day within the arc (0-indexed)

  // Pause tracking
  pauseReason String?
  pausedAt    DateTime?

  // Completion tracking
  completedAt       DateTime?
  sessionsCompleted Int       @default(0)

  child ChildProfile @relation(fields: [childId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Only one active arc per child at a time (enforced in application logic)
  @@index([childId, status])
  @@map("training_arc_states")
}

model Facility {
  id       String  @id @default(cuid())
  parentId String  // Owner scope (parent user)
  name     String
  city     String?
  mapsUrl  String? // User-provided Google Maps URL (not verified in MVP)

  // Reuse tracking
  isSaved  Boolean @default(false)
  lastUsed DateTime?

  parent     ParentUser @relation(fields: [parentId], references: [id], onDelete: Cascade)
  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Future upgrade: When enabling Places Autocomplete, add googlePlaceId and mark facilities verified
  // googlePlaceId String?
  // isVerified    Boolean @default(false)

  @@map("facilities")
}

model Coach {
  id          String  @id @default(cuid())
  parentId    String  // Owner scope (parent user)
  displayName String
  notes       String?

  // Reuse tracking
  isSaved  Boolean @default(false)
  lastUsed DateTime?

  parent     ParentUser @relation(fields: [parentId], references: [id], onDelete: Cascade)
  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coaches")
}

model Program {
  id       String      @id @default(cuid())
  parentId String      // Owner scope (parent user)
  name     String
  type     ProgramType @default(OTHER)

  // Reuse tracking
  isSaved  Boolean @default(false)
  lastUsed DateTime?

  parent     ParentUser @relation(fields: [parentId], references: [id], onDelete: Cascade)
  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("programs")
}

// Focus tags for activities (scanning, decision_chain, etc.)
model FocusTag {
  id          String @id @default(cuid())
  key         String @unique
  label       String
  description String?
  category    String // "skill_track" | "general"

  activityTags ActivityFocusTag[]

  @@map("focus_tags")
}

model ActivityFocusTag {
  id         String @id @default(cuid())
  activityId String
  focusTagId String

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  focusTag FocusTag @relation(fields: [focusTagId], references: [id])

  @@unique([activityId, focusTagId])
  @@map("activity_focus_tags")
}

// Highlight preset chips
model HighlightChip {
  id    String @id @default(cuid())
  key   String @unique
  label String
  icon  String?

  activityLogs ActivityHighlightLog[]

  @@map("highlight_chips")
}

model ActivityHighlightLog {
  id          String @id @default(cuid())
  activityId  String
  highlightId String

  activity  Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  highlight HighlightChip @relation(fields: [highlightId], references: [id])

  @@unique([activityId, highlightId])
  @@map("activity_highlight_logs")
}

// Next focus preset chips
model NextFocusChip {
  id    String @id @default(cuid())
  key   String @unique
  label String
  icon  String?

  activityLogs ActivityNextFocusLog[]

  @@map("next_focus_chips")
}

model ActivityNextFocusLog {
  id          String @id @default(cuid())
  activityId  String
  nextFocusId String

  activity  Activity      @relation(fields: [activityId], references: [id], onDelete: Cascade)
  nextFocus NextFocusChip @relation(fields: [nextFocusId], references: [id])

  @@unique([activityId, nextFocusId])
  @@map("activity_next_focus_logs")
}

// ============================================
// SKILL TRACK DRILLS (Scanning, Decision Chain)
// ============================================

model SkillTrackDrill {
  id                   String @id @default(cuid())
  key                  String @unique // e.g., "scanning.3point_scan"
  title                String
  track                String // "scanning" | "decision_chain"
  durationMinutes      Int
  recommendedFrequency String // e.g., "2x/week"
  animationKey         String
  whyItMatters         String
  coachTips            Json   // JSON array of strings
  metricConfig         Json   // JSON config for tap-first metrics

  logs SkillTrackDrillLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("skill_track_drills")
}

model SkillTrackDrillLog {
  id         String @id @default(cuid())
  childId    String
  drillId    String
  repsCount  Int?
  confidence Int?   // 1-5
  metricData Json?  // Additional metric data

  child ChildProfile    @relation(fields: [childId], references: [id], onDelete: Cascade)
  drill SkillTrackDrill @relation(fields: [drillId], references: [id])

  createdAt DateTime @default(now())

  @@map("skill_track_drill_logs")
}
